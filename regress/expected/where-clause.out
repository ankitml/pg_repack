SET client_min_messages = warning;
-- Create a test table with some data
CREATE TABLE tbl_where_clause (
    id int PRIMARY KEY,
    value text,
    active boolean,
    "column with space" text
);
-- Insert some test data
INSERT INTO tbl_where_clause VALUES (1, 'one', true, 'one');
INSERT INTO tbl_where_clause VALUES (2, 'two', true, 'two');
INSERT INTO tbl_where_clause VALUES (3, 'three', false, 'three');
INSERT INTO tbl_where_clause VALUES (4, 'four', false, 'four');
INSERT INTO tbl_where_clause VALUES (5, 'five', true, 'five');
-- Check initial data
SELECT * FROM tbl_where_clause ORDER BY id;
 id | value | active | column with space 
----+-------+--------+-------------------
  1 | one   | t      | one
  2 | two   | t      | two
  3 | three | f      | three
  4 | four  | f      | four
  5 | five  | t      | five
(5 rows)

-- Run pg_repack with where clause to only repack active rows
\! pg_repack --dbname=contrib_regression --table=tbl_where_clause --where-clause="active = true"
INFO: repacking table "public.tbl_where_clause"
-- Verify data after repack
SELECT * FROM tbl_where_clause ORDER BY id;
 id | value | active | column with space 
----+-------+--------+-------------------
  1 | one   | t      | one
  2 | two   | t      | two
  5 | five  | t      | five
(3 rows)

-- Insert more data to verify the where clause worked correctly
INSERT INTO tbl_where_clause VALUES (6, 'six', true, 'six');
INSERT INTO tbl_where_clause VALUES (7, 'seven', false, 'seven');
-- Run pg_repack with a different where clause
\! pg_repack --dbname=contrib_regression --table=tbl_where_clause --where-clause="id > 3"
INFO: repacking table "public.tbl_where_clause"
-- Verify data after second repack
SELECT * FROM tbl_where_clause ORDER BY id;
 id | value | active | column with space 
----+-------+--------+-------------------
  5 | five  | t      | five
  6 | six   | t      | six
  7 | seven | f      | seven
(3 rows)

-- Test with where clause and order-by together
\! pg_repack --dbname=contrib_regression --table=tbl_where_clause --where-clause="active = true" --order-by="value"
INFO: repacking table "public.tbl_where_clause"
-- Verify data after repack with order-by
SELECT * FROM tbl_where_clause ORDER BY id;
 id | value | active | column with space 
----+-------+--------+-------------------
  5 | five  | t      | five
  6 | six   | t      | six
(2 rows)

-- Test with non-existent column in where clause (should fail)
\! pg_repack --dbname=contrib_regression --table=tbl_where_clause --where-clause="non_existent_column = true"
ERROR: invalid WHERE clause: column "non_existent_column" does not exist
-- Test with special character in column name without proper quoting (should fail)
\! pg_repack --dbname=contrib_regression --table=tbl_where_clause --where-clause="column with space = 'test'"
ERROR: invalid WHERE clause: syntax error at or near "column"
-- Clean up
DROP TABLE tbl_where_clause; 
